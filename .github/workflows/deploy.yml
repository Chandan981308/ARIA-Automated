name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  ci-check:
    name: Run CI checks
    uses: ./.github/workflows/ci.yml

  deploy-backend:
    name: Deploy Backend
    needs: ci-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Build backend artifact
        run: |
          cd backend
          mkdir -p ../dist/backend
          cp -r app/ ../dist/backend/
          cp requirements.txt ../dist/backend/
          cp init_db.sql ../dist/backend/

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ github.sha }}
          path: dist/backend/
          retention-days: 30

      # ──────────────────────────────────────────────
      # Uncomment ONE of the deployment options below
      # and configure the required secrets in your
      # GitHub repo Settings > Secrets and variables
      # ──────────────────────────────────────────────

      # ── Option 1: Deploy to a VPS/EC2 via SSH ──
      # - name: Deploy to server via SSH
      #   uses: appleboy/ssh-action@v1
      #   with:
      #     host: ${{ secrets.SERVER_HOST }}
      #     username: ${{ secrets.SERVER_USER }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       cd /opt/aria
      #       git pull origin main
      #       cd backend
      #       source venv/bin/activate
      #       pip install -r requirements.txt
      #       sudo systemctl restart aria-backend

      # ── Option 2: Deploy to AWS Elastic Beanstalk ──
      # - name: Deploy to AWS EB
      #   uses: einaregilsson/beanstalk-deploy@v22
      #   with:
      #     aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     application_name: aria-backend
      #     environment_name: aria-backend-prod
      #     region: ap-south-1
      #     version_label: ${{ github.sha }}
      #     deployment_package: dist/backend/

      # ── Option 3: Build & push Docker image ──
      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}
      # - name: Build and push Docker image
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: backend/
      #     push: true
      #     tags: ${{ secrets.DOCKER_USERNAME }}/aria-backend:latest,${{ secrets.DOCKER_USERNAME }}/aria-backend:${{ github.sha }}

  deploy-frontend:
    name: Deploy Frontend
    needs: ci-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:8000/api/v1' }}
          NEXT_PUBLIC_WS_URL: ${{ secrets.NEXT_PUBLIC_WS_URL || 'ws://localhost:8000' }}
          NEXT_PUBLIC_APP_NAME: ARIA Voice Agent
          NEXT_PUBLIC_APP_VERSION: 1.0.0
        run: |
          cd frontend
          npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-${{ github.sha }}
          path: frontend/.next/
          retention-days: 30

      # ──────────────────────────────────────────────
      # Uncomment ONE of the deployment options below
      # ──────────────────────────────────────────────

      # ── Option 1: Deploy to Vercel ──
      # - name: Deploy to Vercel
      #   uses: amondnet/vercel-action@v25
      #   with:
      #     vercel-token: ${{ secrets.VERCEL_TOKEN }}
      #     vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
      #     vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
      #     vercel-args: '--prod'
      #     working-directory: frontend/

      # ── Option 2: Deploy to Netlify ──
      # - name: Deploy to Netlify
      #   uses: nwtgck/actions-netlify@v3
      #   with:
      #     publish-dir: frontend/.next/
      #     production-deploy: true
      #   env:
      #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      #     NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # ── Option 3: Deploy to server via SSH (same as backend) ──
      # - name: Deploy to server via SSH
      #   uses: appleboy/ssh-action@v1
      #   with:
      #     host: ${{ secrets.SERVER_HOST }}
      #     username: ${{ secrets.SERVER_USER }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       cd /opt/aria/frontend
      #       git pull origin main
      #       npm ci
      #       npm run build
      #       pm2 restart aria-frontend
